Calibration
===========

Introduction to Calibration and MEF
-----------------------------------

Fluorescence data obtained via flow cytometry is frequently reported in arbitrary units (a.u.), which have the following issues:

1. Fluorescence values in a.u depend on the instrument used.
2. Even when using the same instrument, fluorescence values in a.u. depend on the acquisition settings used.
3. Even when these two are kept constant, fluorescence values in a.u. can change in time due to instrument drift.

Because of this, the only meaningful results based on flow cytometry that are frequently presented are ratios of measured reporter in two different conditions (i.e. fold-change). However, absolute levels of reporter cannot be quantitatively compared across laboratories, or between different different biological systems that require different acquisition settings, and not even between different samples of the same system taken by the same person across large periods of time.

To compensate for some of these effects, manufacturers provide calibration particles. These are a mixture of 4-8 subpopulations of microbeads, each one containing different amounts of a certain fluorophore. The fluorescence of each subpopulation is specified by the manufacturer in **Molecules of Equivalent Fluorophore (MEF)**, the number of fluorophores in solution that result in the same fluorescence as one microbead. Calibration particles can then be measured in every experiment to obtain the fluorescence of each subpopulation in a.u. Using these fluorescence values and the MEF values provided by the manufacturer, one can construct a standard curve that maps fluorescence from a.u. to MEF. This standard curve can then be used to convert the fluorescence of cell samples to MEF.

Expressing fluorescence of cellular samples in MEF automatically eliminates issues 2 and 3. Issue 1 is also eliminated if the calibration beads' fluorophore is the same as the one used in cellular samples. If not, instrument-dependence can still be eliminated by performing a one-time calibration using a common cellular sample. At the very least, transforming to MEF makes cellular samples inside a laboratory comparable.

The Process of MEF Calibration
------------------------------

We will now give a short description of the process that ``FlowCal`` uses to calibrate fluorescence data to MEF, and show some of the plots produced in the process. A discussion on the exact figures generated by the Excel UI and how to use these to debug common problems can be found :doc:`here</excel_ui/outputs>`. A more technical discussion of the MEF calibration procedure from the perspective of :func:`FlowCal.mef.get_transform_fxn`, the function that does most of the calibration work, can be found :doc:`here</python_tutorial/mef>`.

To perform MEF calibration, the following steps are typically followed:

1. Measurement of Calibration Beads
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Calibration beads must be measured in every experiment, using the same acquisition settings as when measuring cell samples. The figure below shows typical flow cytometry data from calibration beads.

.. image:: https://www.dropbox.com/s/e3md4qnqox3icj0/fundamentals_calibration_1.png?raw=1

The top subfigure shows data from the forward/side scatter channels, whereas the bottom one shows one of the fluorescence channels. Note how several populations with different fluorescence values are evident in the bottom plot.

2. Elimination of Bead Aggregates and Other Debris
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Notice, in the figure above, that two different populations are present in the forward/side scatter plot. The faint population on the right/upper portion of the plot corresponds to bead aggregates. These are obviously undesired, as we are only interested in single bead fluorescence. This sort of situation is normally dealt with by "gating", which involves manually drawing a region of interest and retaining the events that fall inside. ``FlowCal`` performs :doc:`density gating<density_gate>`, an automated procedure to eliminate aggregates and other events that are clearly different from the main population of interest. The figure below shows a black contour surrounding the region identified by density gating in the forward/side scatter plot, showing that density gating can distinguish single beads from aggregates. Notice also how small peaks in the fluorescence plot disappear after density-gating, which is consistent with the eliminated population being composed of agglomerations of multiple beads.

.. image:: https://www.dropbox.com/s/qgqcbdqrrrvp7yx/fundamentals_calibration_2.png?raw=1

3. Identification of Bead Subpopulations
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

In order to calculate the average fluorescence of each subpopulation, the individual events corresponding to each must first be identified. The figure below shows one of the plots produced by ``FlowCal`` after an automated clustering algorithm has properly identified each subpopulation. Note how this can be achieved using information from several fluorescence channels at the same time.

.. image:: https://www.dropbox.com/s/2ueaelf0jmgigdh/fundamentals_calibration_3.png?raw=1

Next, the average fluorescence of each subpopulation is calculated. Some subpopulations, however, can have fluorescence values that are outside the limit of detection of the instrument, and therefore their events will show saturated fluorescence values. These subpopulations should not be considered further in the analysis. ``FlowCal`` discards these automatically.

The figure below shows the individual subpopulations with a vertical line representing their median fluorescence. In addition, subpopulations that were automatically discarded are shown colored in gray.

.. image:: https://www.dropbox.com/s/yemed2xr84xdydj/fundamentals_calibration_4.png?raw=1

4. Calculation of a Standard Curve
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Having the fluorescence of the individual populations, as measured by the flow cytometer, and the MEF values provided by the manufacturer, a standard curve can be calculated to transform fluorescence of any event to MEF. The figure below shows an example of such a standard curve. ``FlowCal`` uses the concept of a "bead fluorescence model", which is directly fitted to bead data but not immediately applicable to cells. However, some small mathematical manipulations turn this bead fluorescence model into a standard curve that is readily applicable to cells.

.. image:: https://www.dropbox.com/s/wpysi3gfm8lkxxz/fundamentals_calibration_5.png?raw=1

Note that in this figure, the numbers produced by the flow cytometer are logarithmically related to fluorescence values. This is true in a flow cytometer that uses a logarithmic amplifier. Instruments with linear amplifiers are treated slightly differently.

5. Conversion of Cell Fluorescence to MEF
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Finally, the fluorescence of any cell sample can be turned into MEF by using the standard curve obtained above.